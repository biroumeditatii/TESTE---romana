<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Panou Profesor - Control & Monitorizare</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    
    <link rel="manifest" href="manifest_prof.json">
    <link rel="apple-touch-icon" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --bg-color: #f1f5f9; 
            --card-bg: #ffffff; 
            --primary: #4f46e5; 
            --success: #10b981; 
            --orange: #f97316; 
            --error: #ef4444; 
            --text-main: #1e293b; 
            --text-muted: #64748b;
        }
        
        html, body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 0;
            height: 100%; width: 100%;
            position: fixed; overflow: hidden;
            overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
        }

        .container { 
            max-width: 1000px; margin: 0 auto; padding: 20px;
            height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; margin-left: 5px; }
        .btn-launch { background: var(--success); }
        .btn-stop { background: var(--error); }
        .btn-reset { background: #64748b; }
        .btn-delete-all { background: #dc2626; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2); }
        
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; margin-left: 4px; border-radius: 6px; border: none; cursor: pointer; color: white; }
        .btn-edit { background: #f59e0b; }
        .btn-delete { background: var(--error); }

        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; background: #e2e8f0; color: #64748b; }
        .active-now { background: #dcfce7; color: #166534; border: 1px solid #10b981; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding-bottom: 40px; }
        .student-card { 
            background: white; padding: 20px; border-radius: 18px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 4px solid var(--primary);
            cursor: pointer; transition: transform 0.1s;
        }
        
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; margin: 12px 0; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 5px; transition: width 0.5s; }
        
        .card-footer { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; }
        .actions-row { display: flex; justify-content: flex-end; margin-top: 15px; border-top: 1px solid #f1f5f9; padding-top: 10px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background-color: white; margin: 8vh auto; padding: 25px; border-radius: 24px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .res-item { padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; flex-direction: column; }
        .res-correct { color: var(--success); font-weight: 700; }
        .res-wrong { color: var(--error); font-weight: 700; }
        .res-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Control Profesor</h1>
            <table>
                <thead>
                    <tr><th>Nume Test</th><th>Acțiune</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Test 1: Harap-Alb</td>
                        <td><button class="btn btn-launch" onclick="lanseazaTest('test1.html', 'Harap-Alb')">LANSEAZĂ</button></td>
                    </tr>
                    <tr>
                        <td>Test 2: Moara cu noroc</td>
                        <td><button class="btn btn-launch" onclick="lanseazaTest('test2.html', 'Moara cu noroc')">LANSEAZĂ</button></td>
                    </tr>
                </tbody>
            </table>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed #e2e8f0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <strong>Stare:</strong>&nbsp;<span id="current-status" class="status-badge">Inactiv</span>
                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button class="btn btn-stop" onclick="opresteTestul()">OPREȘTE</button>
                    <button class="btn btn-delete-all" onclick="stergeTotiElevii()">Ștergere Elevi</button>
                    <button class="btn btn-reset" onclick="resetClasa()">RESETEAZĂ LISTA</button>
                </div>
            </div>
        </div>

        <h2>Monitorizare Live (apasă pe elev pentru detalii)</h2>
        <div id="students-grid" class="grid"></div>
    </div>

    <div id="resModal" class="modal">
        <div class="modal-content">
            <h2 id="modalStudentName" style="margin-top:0; color:var(--primary);">Rezultate Elev</h2>
            <div id="modalBody"></div>
            <button class="btn" style="background:var(--primary); width:100%; margin-top:20px; padding:12px;" onclick="inchideModal()">Închide</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2xOfKBy7FdA6uIyM0ij5ryHTop0yL3pg",
      authDomain: "bacromana-6f3eb.firebaseapp.com",
      databaseURL: "https://bacromana-6f3eb-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bacromana-6f3eb",
      storageBucket: "bacromana-6f3eb.firebasestorage.app",
      messagingSenderId: "1087294677634",
      appId: "1:1087294677634:web:d92bf75a8b58f7b351ca9b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // CHEI ACTUALIZATE - 100% CONFORM TEXTULUI TAU
    const CHEI = {
        "test1.html": ["modernizarea", "Marilor Clasici", "Titu Maiorescu", "Junimii", "adepți ai clasicismului", "modele", "repere: pentru proza realistă, Ioan Slavici, pentru basmul cult, Ion Creangă, pentru opera dramatică, Ion Luca Caragiale și pentru lirica romantică, Mihai Eminescu", "clasei de opere", "narațiunea", "epikos", "Bine-Rãu", "călătorie inițiatică", "adjuvanți", "trei", "nunta", "realist-psihologică", "Alexandru Piru", "bildungsroman", "personalității", "fântânã", "botez", "Eliade", "nonvaloare", "jurământului", "smicelele de măr dulce", "paloș", "titlul", "slugă naivă", "cronotopul", "illo tempore", "III-a", "omniscientă", "narativ", "benevolentiae", "supranaturale", "directă", "Duminică", "Spânul", "necesar"],
        "test2.html": ["modernizarea", "Marilor Clasici", "Titu Maiorescu", "Junimii", "adepți ai clasicismului", "modele", "repere", "repere", "1881", "Novele din popor", "realismului psihologic", "mimesis", "felii de viață", "om-societate", "Ghiță", "alter egoul autorului", "verosimilitate", "Ineu, Arad, Fundureni", "Ana", "Ghiță", "descrierilor", "sobru/ impersonal", "al XIX-lea", "narațiunea", "epikos", "dimensiune medie", "conflict concentrat", "cronologic", "plan narativ", "asupra conturãrii lui Ghiță", "polarizeaza interesul epic", "relația obsesivă", "resorturilor intime", "radiografierea și sondarea psihicului", "supratema degradării umane sub semnul banului", "destinului schimbător", "conflict exterior", "aspru, viclean", "unic stăpân al locurilor", "dârz și motivat", "om rău şi primejdios", "tovarăş", "împrejurări", "șederea la Moara cu noroc depinde numai de bunul său plac", "călău-victimă", "tragedia antică", "jocul porcarului", "mințise", "treăpta a degradării morale", "coborârii în infern", "de teamă, de suferință morală", "soțul n-o mai iubește", "să macine familia", "oamenilor lui Lică", "personaj reflector", "a fi dorit prea mult", "fatalității oarbe", "triunghiul de forță", "moartea în lanț", "dintre Bine și Rău", "foc", "oasele albe care ies din cenușa neagră", "morii care „macină” destine", "malefic", "unei noi șanse", "aducător de ghinion", "analitică", "unicizează negativ locul", "hanul lui Sadoveanu", "moralizatoare", "bătrânei", "măsura în toate", "noaptea", "rãsãritul", "au loc în aceste intervale de timp", "persoana a III-a", "cronologic", "înlănțuirea", "dramatizată prin dialogul", "evoluția acțiunii", "personajele", "omniscientă", "cronologia", "17", "„rama” cugetărilor bătrânei", "contrapunctul", "care, la Moara cu noroc începe", "uitat de Divinitate", "psihologic", "Sfântul Gheorghe și până la Paște", "corp sferoid", "oraculară/ premonitorie", "provocarea destinului atrage pedepse grave", "la echilibru", "Omul să fie mulţumit cu sărăcia sa...", "bătrânei", "moralizatoare", "nu are să iasă bine", "totul dinainte", "încălcă normele morale", "purificator", "epilogul", "pentru un nou început", "instanțe fundamentale", "ființe de hârtie", "teoria literară", "„plate” și “rotunde\"", "o dimensiune exterioară, alta interioară", "verosimili", "demonic", "romantica", "polarizează interesul epic", "autorului", "arivistul, dornicul de îmbogățire rapidă", "omul moral, pater familias", "dilematic", "imoral", "Sfântul Gheorghe", "învins de „balaur”", "sumar", "puternic și umeros ca un taur", "Ana era tânără și frumoasa, (…), iar el însuși, înalt și spătos, o purta ca pe o pană", "comportament", "căutări", "întrebări", "temeri", "oamenii legii", "Divinitatea", "patima banului", "om e supus", "pluriperspectiva/ tehnica oglinzilor paralele/ tehnica cercurilor concentrice", "subordonare şi inferioritatea", "responsabil", "subordonat"]
    };

    function normalize(t) { return t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ț/g, "t").replace(/ș/g, "s").toLowerCase().trim(); }

    function lanseazaTest(fileId, displayName) {
        db.ref('setari').set({ test_activ: true, test_id: fileId, test_nume: displayName });
    }
    
    function opresteTestul() { db.ref('setari/test_activ').set(false); }
    function stergeTotiElevii() { if(confirm("Ștergi TOȚI elevii?")) db.ref('clasa').remove(); }
    function resetClasa() { if(confirm("Resetezi lista?")) db.ref('clasa').remove(); }

    function deschideDetalii(id) {
        db.ref('clasa/' + id).once('value').then((snap) => {
            const s = snap.val();
            if(!s || !s.raspunsuri) return alert("Elevul nu a început.");
            const key = CHEI[s.test_id] || CHEI["test1.html"];

            document.getElementById('modalStudentName').innerText = s.nume + " - " + (s.test_nume || "");
            const body = document.getElementById('modalBody');
            body.innerHTML = '';

            const raspunsuriElev = Array.isArray(s.raspunsuri) ? s.raspunsuri : Object.values(s.raspunsuri);
            raspunsuriElev.forEach((r, i) => {
                const correctStr = key[i] || "";
                const ok = normalize(r || "") === normalize(correctStr);
                body.innerHTML += `
                    <div class="res-item">
                        <span>${i+1}: <span class="${ok ? 'res-correct' : 'res-wrong'}">${r || '(gol)'}</span></span>
                        ${!ok ? `<span class="res-label">Corect: ${correctStr}</span>` : ''}
                    </div>`;
            });
            document.getElementById('resModal').style.display = 'block';
        });
    }

    function inchideModal() { document.getElementById('resModal').style.display = 'none'; }

    function deleteStudent(id, event) { 
        event.stopPropagation();
        if(confirm(`Elimini pe ${id}?`)) db.ref('clasa/' + id).remove(); 
    }

    function editStudent(oldName, event) {
        event.stopPropagation();
        const newName = prompt("Nume nou:", oldName);
        if (newName && newName !== oldName) {
            db.ref('clasa/' + oldName).once('value').then((snap) => {
                const data = snap.val();
                data.nume = newName;
                db.ref('clasa/' + newName).set(data).then(() => db.ref('clasa/' + oldName).remove());
            });
        }
    }

    db.ref('setari').on('value', snap => {
        const d = snap.val();
        const el = document.getElementById('current-status');
        el.innerText = (d && d.test_activ) ? "ACTIV: " + d.test_nume : "INACTIV";
        el.className = (d && d.test_activ) ? "status-badge active-now" : "status-badge";
    });

    db.ref('clasa').on('value', snapshot => {
        const grid = document.getElementById('students-grid');
        grid.innerHTML = '';
        const data = snapshot.val();
        if (!data) return;

        for (let id in data) {
            const s = data[id];
            const p = s.progres || 0;
            const barColor = p < 30 ? "#ef4444" : (p < 60 ? "#f97316" : (p < 85 ? "#a3e635" : "#22c55e"));
            
            grid.innerHTML += `
                <div class="student-card" onclick="deschideDetalii('${id}')">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${s.nume}</strong>
                        <span style="font-size:0.65rem; color:var(--text-muted);">${s.test_nume || ''}</span>
                    </div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${p}%; background-color:${barColor};"></div></div>
                    <div class="card-footer">
                        <span>Scor: ${s.scor || '0/0'}</span>
                        <span>${p}%</span>
                    </div>
                    <div class="actions-row">
                        <button class="btn btn-sm btn-edit" onclick="editStudent('${id}', event)">Editează</button>
                        <button class="btn btn-sm btn-delete" onclick="deleteStudent('${id}', event)">Șterge</button>
                    </div>
                </div>`;
        }
    });

    window.onclick = function(event) { if (event.target == document.getElementById('resModal')) inchideModal(); }
</script>
</body>
</html>
